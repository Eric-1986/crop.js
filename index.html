<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>crop.js</title>
<link rel="stylesheet" href="lib/bootstrap-3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="lib/bootstrap-3.3.6/css/bootstrap-theme.min.css">
<link rel='stylesheet' href='lib/jquery-ui-1.11.4/jquery-ui.min.css'>
<link rel='stylesheet' href='lib/c3.min.css'>
<link rel='stylesheet' href='lib/codemirror-5.10/codemirror.css'>
<script src="lib/jquery-2.2.0.min.js"></script>
<script src="lib/jquery-ui-1.11.4/jquery-ui.min.js"></script>
<script src="lib/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script src="lib/d3.min.js"></script>
<script src="lib/c3.min.js"></script>
<script src="lib/c3.min.js"></script>
<script src="lib/codemirror-5.10/codemirror.min.js"></script>
<script type="text/javascript">

$(function () {
  var editor = CodeMirror.fromTextArea($('textarea').get(0), { 
        mode: 'text/javascript',
        keyMap: 'sublime'
      }),
      worker = new Worker('lib/crop.min.js'),
      weather = (function () {
        var data = {
            tmin: [],
            tmax: [],
            tavg: [],
            globrad: [],
            wind: [],
            sunhours: [],
            relhumid: [],
            precip: [],
            ppf: [],
            daylength: [],
            f_directrad: [],
            date: [],
            doy: [],
            exrad: []
          },        
          err = false;
        [ 'rr_52.625_13.375.json',
          'tn_52.625_13.375.json',
          'tx_52.625_13.375.json',
          'tg_52.625_13.375.json' ].forEach(function (file) {
          $.ajax({
            type: 'GET',
            url: 'weather/' + file,
            dataType: 'json',
            success: function(obj) {
              var vals = [],
                  type = file.substring(0, 2);
              for (var i = 0; i < obj.values.length; i++)
                vals.push(obj.values[i] * obj.scale);
              if (type === 'rr')
                data.precip = vals;
              else if (type === 'tn')
                data.tmin = vals;
              else if (type === 'tx')
                data.tmax = vals;
              else if (type === 'tg')
                data.tavg = vals;
              if (data.precip.length && data.tmin.length &&
                  data.tavg.length && data.tmax.length) {
                console.log(data);
                return data;
              }
            },
            error: function () {
              console.log(arguments);
              err = true;
            }
          });
        });      
      }());


  worker.onmessage = function (evt) {
    var data = evt.data;
    console.log(data);
    if (data.done) {

    }
  };

  var obj = JSON.parse(editor.getValue());

  worker.postMessage({
    run: {
      debug: true,
      verbose: true,
      weather: weather,
      sim: obj.simulation,
      siteAndProd: {
        site: obj.site,
        production: obj.production
      }
    }
  });



  
});

</script>
<style type="text/css">

body {
  background-color: rgba(249, 249, 249, 1);
  font-size: 14px;
  font-family:"Helvetica Neue", Arial, Helvetica, sans-serif;
  box-sizing: border-box;
}

.CodeMirror, select, #chart {
  border: 1px solid;
  border-color: lightgrey;
  border-radius: 3px;  
}

button {
  width: 80px;
  height: 30px;
  margin-top: 16px;
  margin-bottom: 10px;
  margin-right: 16px;
  border: 1px solid;
  border-color: grey;
  border-radius: 3px;
  float: right;
}

#chart {

}

</style>
</head>
<body>

  <div class="container">
    <div class='row row-centered'>
      <div class='col-lg-2'>
        <select multiple>
          <option value="volvo">Volvo</option>
          <option value="saab">Saab</option>
          <option value="opel">Opel</option>
          <option value="audi">Audi</option>
        </select>        
      </div>
      <div id='chart' class='col-lg-8'>
      </div>
    </div>
    <div class='row'>
      <div class='col-lg-6'>
        <textarea>
{
  "simulation": {
    "time": {
      "startDate": "1996-01-01",
      "endDate": "1997-12-31"
    },
    "switches": {
      "nitrogenResponseOn": true,
      "waterDeficitResponseOn": true
    },
    "init": {
      "percentageFC": 1
    }
  },
  "site": {
    "latitude": 52.625,
    "slope": 0,
    "heightNN": 1,
    "horizons": [
      {
        "thickness": 0.2,
        "organicMatter": 0.015,
        "sand": 0.60,
        "clay": 0.05,
        "sceleton": 0.02
      },
      {
        "thickness": 0.5,
        "organicMatter": 0.015,
        "sand": 0.60,
        "clay": 0.05,
        "sceleton": 0.02
      },
      {
        "thickness": 2.0,
        "organicMatter": 0.01,
        "sand": 0.60,
        "clay": 0.05,
        "sceleton": 0.02
      }
    ]
  },
  "production": {
    "crops": [
      {
        "model": "generic",
        "species": [
          {
            "name": "winter rye"
          }
        ],
        "sowingDate": "1996-10-01",
        "plantDryWeight": 225,
        "percNTRansplant": 0.07,
        "finalHarvestDate": "2000-10-01",
        "residuesRemoval": 0.85,
        "tillageOperations": [
          {
            "date": "1996-09-02",
            "method": "Plough",
            "depth": 30
          }
        ],
        "irrigations": [
          {
            "date": "1997-06-01",
            "method": "Sprinkler",
            "eventType": "Fixed",
            "threshold": 0.2,
            "area": 1,
            "amount": 50,
            "NConc": 0
          },
          {
            "date": "1997-06-15",
            "method": "Sprinkler",
            "eventType": "Fixed",
            "threshold": 0.2,
            "area": 1,
            "amount": 50,
            "NConc": 0
          }
        ],
        "organicFertilisers": [],
        "mineralFertilisers": [
          {
            "name": "Ammonium Nitrate",
            "date": "1997-04-01",
            "method": "Fixed",
            "amount": 50
          },
          {
            "name": "Ammonium Nitrate",
            "date": "1997-05-15",
            "method": "Fixed",
            "amount": 50
          }
        ]
      }
    ]
  }
}
      </textarea>
      </div>
      <div class='col-lg-6'>
        <textarea></textarea>
      <div>
    </div>
    <div class='row'>
      <button>run</button>
    </div>
  </div>

</body>
</html>                                   
